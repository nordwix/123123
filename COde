import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

public class LibraryApp {
    
    static abstract class BaseEntity {
        protected int id;
        
        public BaseEntity(int id) {
            this.id = id;
        }

        public void displayInfo() {
            System.out.println("BaseEntity: Displaying info for ID " + id);
        }

        public int getId() {
            return this.id;
        }
    }

    static abstract class SystemUser extends BaseEntity {
        protected String login;
        protected String role;

        public SystemUser(int id, String login, String role) {
            super(id);
            this.login = login;
            this.role = role;
        }

        public boolean authenticate(String password) {
            System.out.println(this.getClass().getSimpleName() + " method: authenticate - Needs password check.");
            return true;
        }

        @Override
        public void displayInfo() {
            System.out.println("SystemUser: ID " + id + ", Login: " + login + ", Role: " + role);
        }
    }
    
    static class User extends SystemUser {
        private String firstName;
        private String lastName;
        private String hashedPassword;

        public User(int userId, String firstName, String lastName, String login, String password) {
            super(userId, login, "звичайний користувач");
            this.firstName = firstName;
            this.lastName = lastName;
            this.hashedPassword = String.valueOf(Objects.hash(password));
        }
        
        public boolean login(String password) {
            System.out.println("User method: login - Login attempt for " + login);
            return super.authenticate(password);
        }

        public String getFullName() {return firstName + " " + lastName;}
        public String getRole() {return role;}
        
        boolean checkAccessRole(String requiredRole) {
            return this.role.equals(requiredRole);
        }

        @Override
        public void displayInfo() {
            System.out.println("User: " + firstName + " " + lastName + ", Role: " + role);
        }
    }

    static class Admin extends User {
        private List<String> actionsLog;

        public Admin(int adminId, String firstName, String lastName, String login, String password) {
            super(adminId, firstName, lastName, login, password);
            this.role = "адміністратор";
            this.actionsLog = new ArrayList<>();
        }

        public boolean depositBook(LibraryResource resource, LibraryCatalog catalog) {
            if (!catalog.isResourceInCatalog(resource.getId())) {
                catalog.internalAddResource(resource); 
                this.actionsLog.add("Додано ресурс ID: " + resource.getId());
                return true;
            }
            return false;
        }

        public void blockUser(User user) {
            this.actionsLog.add("Заблоковано користувача ID: " + user.getId());
        }

        @Override
        public void displayInfo() {
            System.out.println("ADMIN: " + getFullName() + ", Log count: " + actionsLog.size());
        }
    }

    static abstract class LibraryResource extends BaseEntity {
        protected String title;
        protected String author;

        public LibraryResource(int id, String title, String author) {
            super(id);
            this.title = title;
            this.author = author;
        }

        public String getTitle() {return title;}
        public String getAuthor() {return author;}
    }
    
    static class Book extends LibraryResource {
        private int year;
        private String fileLink;
        private boolean isAvailable;

        public Book(int id, String title, String author, int year, String fileLink) {
            super(id, title, author);
            this.year = year;
            this.fileLink = fileLink;
            this.isAvailable = true;
        }

        public boolean isAvailable() {return isAvailable;}
        public void setFileLink(String fileLink) {this.fileLink = fileLink;}

        void setAvailability(boolean status) {
            this.isAvailable = status;
        }

        @Override
        public void displayInfo() {
            System.out.println("Book: Title: " + title + ", Author: " + author + ", Year: " + year + ", Available: " + isAvailable);
        }
    }
    
    static class AudioBook extends LibraryResource {
        private int durationSeconds;
        
        public AudioBook(int id, String title, String author, int durationSeconds) {
            super(id, title, author);
            this.durationSeconds = durationSeconds;
        }

        @Override
        public void displayInfo() {
            System.out.println("AudioBook: Title: " + title + ", Duration: " + durationSeconds / 60 + " min.");
        }
    }

    static class LibraryCatalog {
        private List<LibraryResource> resources;
        private String catalogName;

        public LibraryCatalog(String catalogName) {
            this.catalogName = catalogName;
            this.resources = new ArrayList<>();
        }

        public int getTotalResourceCount() {return resources.size();}
        public boolean isResourceInCatalog(int resourceId) {return resources.stream().anyMatch(r -> r.getId() == resourceId);}

        void internalAddResource(LibraryResource resource) {
            this.resources.add(resource);
        }
        
        @Override
        public String toString() {
            return "LibraryCatalog [Name=" + catalogName + ", Total Resources=" + resources.size() + "]";
        }
    }

    static class DownloadOrder {
        private int downloadId;
        private int userId;
        private int resourceId;
        private LocalDateTime downloadDateTime;

        public DownloadOrder(int downloadId) {
            this.downloadId = downloadId;
        }

        public boolean processDownload(User user, Book book) {
            if (!book.isAvailable()) {
                System.out.println(" Помилка: Книга недоступна для завантаження.");
                return false;
            }
            
            this.userId = user.getId();
            this.resourceId = book.getId();
            this.downloadDateTime = LocalDateTime.now();
            book.setAvailability(false); 
            
            System.out.println(" Завантаження ресурсу ID " + book.getId() + " успішне!");
            return true;
        }

        @Override
        public String toString() {
            return "DownloadOrder [ID=" + downloadId + ", User ID=" + userId + ", Resource ID=" + resourceId + ", Time=" + downloadDateTime + "]";
        }
    }
    
    static class Category {
        private int categoryId;
        private String name;
        private List<Integer> resourceIds;

        public Category(int categoryId, String name) {
            this.categoryId = categoryId;
            this.name = name;
            this.resourceIds = new ArrayList<>();
        }

        public void assignResource(int resourceId) {
            if (!resourceIds.contains(resourceId)) {
                resourceIds.add(resourceId);
            }
        }
        
        @Override
        public String toString() {
            return "Category [ID=" + categoryId + ", Name='" + name + "', Resources=" + resourceIds.size() + "]";
        }
    }

    public static void main(String[] args) {
        System.out.println("--- ПР 3&4: Інкапсуляція та Наслідування ---");

        User standardUser = new User(101, "Олена", "Іваненко", "olena_i", "pass123");
        Admin libraryAdmin = new Admin(1, "Петро", "Сидоренко", "admin_p", "root");
        
        Book book1 = new Book(201, "Java. Ефективне програмування", "Джошуа Блох", 2019, "/files/java.pdf");
        AudioBook audio1 = new AudioBook(203, "Міфи Стародавньої Греції", "Стівен Фрай", 3600);
        
        LibraryCatalog mainCatalog = new LibraryCatalog("Центральний Каталог");
        DownloadOrder order1 = new DownloadOrder(5001);
        
        
        System.out.println("\n>>> 1. Демонстрація перевизначення методів (Override):\n");
        BaseEntity base = new Book(99, "Test", "Author", 2000, "link");
        
        base.displayInfo();
        standardUser.displayInfo();
        libraryAdmin.displayInfo();
        audio1.displayInfo();
        
        System.out.println("\n----------------------------------------");
        
        System.out.println(">>> 2. Демонстрація ієрархії та Package-private:\n");
        
        System.out.println("Роль Адміністратора: " + libraryAdmin.getRole());
        
        System.out.println("Кількість ресурсів ДО: " + mainCatalog.getTotalResourceCount());
        libraryAdmin.depositBook(book1, mainCatalog);
        libraryAdmin.depositBook(audio1, mainCatalog);
        System.out.println("Кількість ресурсів ПІСЛЯ: " + mainCatalog.getTotalResourceCount());
        
        System.out.println("\n----------------------------------------");
        
        System.out.println(">>> 3. Демонстрація зміни стану та package-private:\n");
        
        System.out.println("Book1 доступна ДО: " + book1.isAvailable());
        
        order1.processDownload(standardUser, book1);
        
        System.out.println("Book1 доступна ПІСЛЯ: " + book1.isAvailable());
        System.out.println(order1.toString());
        
        System.out.println("\n--- Завершення роботи ---");
    }
}
